# (C) Serge Victor 2020-2024, GPLv3 License
# 
# recently build version of documents is available on permanent storage disk mounted on /LDP

kind: pipeline
type: docker
name: ðŸ—ƒ LDP Builder

workspace:
  path: /builder/src
   
steps:
- name: Martin's builder - Pull Request only (partial build)
  image: tldp/builder:latest
  volumes:
  - name: LDP
    path: /LDP
  when:
    event:
      include:
      - pull_request
  commands:
  - ldptool --dump-cfg
  - rm -rf /LDP/PR
  - mkdir -p /builder/src/BUILD
  - rsync -av /LDP/en /LDP/PR
  - ldptool --loglevel info --builddir /builder/src/BUILD --configfile .github/builder.ldptool.cfg --pubdir /builder/PR/en --list
  - ldptool --loglevel info --builddir /builder/src/BUILD --configfile .github/builder.ldptool.cfg --pubdir /builder/PR/en --publish

steps:
- name: Martin's builder - all revieved commits (full build)
  image: tldp/builder:latest
  volumes:
  - name: LDP
    path: /LDP
  when:
    event:
      exclude:
      - pull_request
  commands:
  - ldptool --dump-cfg
  - rm -rf /LDP/en
  - mkdir /LDP/en
  - mkdir -p /builder/src/BUILD
  - ldptool --loglevel info --builddir /builder/src/BUILD --configfile .github/builder.ldptool.cfg --pubdir /LDP/en --list
  - ldptool --loglevel info --builddir /builder/src/BUILD --configfile .github/builder.ldptool.cfg --pubdir /LDP/en --publish
  - git rev-parse HEAD > /LDP/last-commit-id.txt
  - date > /LDP/build-date.txt

volumes:
- name: LDP
  host:
    path: /LDP

# the happy end.
