---
# (C) Dr Serge Victor 2020-2025, GPLv3 License
# (C) The Linux Documentation Project 2020-2025, GPLv3 License
# 
# recently build version of documents is available on permanent storage disk mounted on /LDP
#
# this file is protected, DO NOT TAMPER without permission from LDP authorised maintainers!
# contact us or create an issue before thinking about any changes.

steps:
#####
#
- name: â‡£â‡£â‡£ Download current full build
  image: rclone/rclone
  environment:
    RCLONE:
      from_secret: RCLONE
  when:
    - event: pull_request
      branch: master
  commands:
  - echo "$RCLONE" > rclone.conf
  - "rclone --config rclone.conf --verbose sync LDP:ldp/en/ /LDP/PR/BUILD"

- name: ðŸ—ƒ Martin's builder - Pull Request only (partial build)
  image: tldp/builder:latest
  directory: /builder
  when:
    - event: pull_request
      branch: master
  commands:
  - pwd
  - ldptool --dump-cfg
  - rm -rf /LDP/PR
  - mkdir -p /LDP/PR/BUILD
  - rsync -av /LDP/en /LDP/PR
  - ldptool --loglevel info --builddir /LDP/PR/BUILD --configfile .github/builder.ldptool.cfg --pubdir /LDP/PR/en --list
  - ionice -c 3 chrt --idle 0 ldptool --loglevel info --builddir /LDP/PR/BUILD --configfile .github/builder.ldptool.cfg --pubdir /LDP/PR/en --publish
  - git rev-parse HEAD > /LDP/PR/last-commit-id.txt
  - date > /LDP/PR/build-date.txt

- name: ðŸ—ƒ Martin's builder - all revieved commits (full build)
  image: tldp/builder:latest
  directory: /builder
  environment:
    GITDIR: /woodpecker/src/github.com/ser/LDP
  volumes:
    - /LDP:/LDP
  when:
    - event: [ push, pull_request_closed, cron, manual ]
  commands:
  - mkdir -p /builder/BUILD
  - mkdir -p /builder/PUBDIR
  - whoami
  - pwd
  - ldptool --dump-cfg
  - ldptool --loglevel info --builddir /builder/BUILD --configfile $GITDIR/.github/builder.ldptool.cfg --pubdir /builder/PUBDIR --list
  - ionice -c 3 chrt --idle 0 ldptool --loglevel info --builddir /builder/BUILD --configfile $GITDIR/.github/builder.ldptool.cfg --pubdir /builder/PUBDIR --publish
  - rsync -av --delete-after /builder/PUBDIR/ /LDP/en
  - cd $GITDIR
  - git rev-parse HEAD > /LDP/last-commit-id.txt
  - date > /LDP/build-date.txt

- name: â‡¡â‡¡â‡¡ Upload full build to our S3
  image: woodpeckerci/plugin-s3
  volumes:
    - /LDP:/LDP
  when:
    - event: [ push, pull_request_closed, cron, manual ]
  settings:
    bucket: ldp
    endpoint: https://tldp.net
    access_key: GK381f3710fdb80f3ae2689d07
    secret_key:
      from_secret: S3
    region: US
    acl: public-read
    strip_prefix: true
    source: /LDP/**/*
    target: /

# the happy end.
